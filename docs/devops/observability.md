# Observability Stack

The platform emits structured logs, metrics, traces, and error reports to provide full visibility into gateway operations.

## Metrics

- **Prometheus endpoint** – `/metrics` exposes default and custom metrics (`api_requests_total`, `job_duration_seconds`, `business_events_total`, `gpu_utilization_percent`).
- **Custom counters** – Business events increment when ingestion or retrieval logic runs. Histograms capture request and job durations.
- **GPU telemetry** – Utilization gauges derive from the CUDA runtime when available; otherwise, values default to `0`.

Prometheus is configured via `ops/monitoring/prometheus.yml` and loaded automatically in Docker Compose and Kubernetes deployments.

## Distributed Tracing

- OpenTelemetry instrumentation wraps FastAPI and gRPC servers via `Medical_KG_rev/observability/tracing.py`.
- Traces default to Jaeger exporters in Docker Compose; override with `MK_TELEMETRY__EXPORTER` and `MK_TELEMETRY__ENDPOINT`.
- Correlation IDs propagate through logs, traces, and HTTP headers (`X-Correlation-ID`).

## Logging

- Logs are JSON-formatted with sensitive fields redacted per `LoggingSettings.scrub_fields`.
- Correlation IDs are generated by middleware and attached to every log line and span.
- Loki and Promtail aggregate container logs in local environments. Update `ops/monitoring/promtail-config.yml` to tail additional paths.

## Dashboards & Alerts

Grafana dashboards reside in `ops/monitoring/grafana/dashboards/`:

- `system_health.json` – request rate, error rate, and latency overview.
- `api_latency.json` – per-endpoint latency tables.
- `gpu_utilization.json` – GPU memory usage.
- `job_processing.json` – job duration histograms and business counters.

Prometheus alert rules in `ops/monitoring/alerts.yml` cover latency regressions and error spikes.

## Error Tracking

Sentry integration is controlled via `MK_OBSERVABILITY__SENTRY__DSN`. When set, the middleware adds FastAPI and logging integrations with contextual tags (environment, correlation ID). Configure alert policies directly in Sentry.

groups:
  - name: api-latency
    rules:
      - alert: HighLatencyP95
        expr: histogram_quantile(0.95, sum(rate(api_request_duration_seconds_bucket[5m])) by (le, path)) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency detected for {{ $labels.path }}"
          description: "P95 latency for {{ $labels.path }} exceeds 500ms"
  - name: error-rates
    rules:
      - alert: ElevatedErrorRate
        expr: sum(rate(api_requests_total{status!~"2.."}[5m])) / sum(rate(api_requests_total[5m])) > 0.05
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Error rate above 5%"
          description: "Investigate failing requests across the gateway"
  - name: embedding-service
    rules:
      - alert: EmbeddingGPUHighUtilization
        expr: avg_over_time(gpu_utilization_percent[5m]) > 95
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Embedding GPU utilisation exceeds 95%"
          description: "Check vLLM batch size and node capacity before saturation causes failures."
      - alert: EmbeddingFailureSpike
        expr: sum(rate(medicalkg_embedding_failures_total[5m])) by (namespace, provider) > 1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Embedding failures detected for {{ $labels.namespace }}"
          description: "Investigate CloudEvents for error_type details and confirm GPU availability."
      - alert: EmbeddingThroughputDrop
        expr: sum(rate(medicalkg_embeddings_generated_total[10m])) < 10
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Embedding throughput dropped below 10 vectors/sec"
          description: "Check cache hit ratio and vLLM health; throughput degraded below expected baseline."
  - name: retrieval-performance
    rules:
      - alert: RetrievalLatencyP95High
        expr: histogram_quantile(0.95, sum(rate(api_request_duration_seconds_bucket{path="/v1/retrieve"}[5m])) by (le)) > 0.6
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Hybrid retrieval latency exceeds 600ms"
          description: "Investigate component failures or saturated rerankers."
      - alert: RetrievalRecallRegression
        expr: medicalkg_retrieval_recall_at_k{dataset="test_set_v1",k="10"} < 0.75
        for: 30m
        labels:
          severity: critical
        annotations:
          summary: "Recall@10 fell below 75%"
          description: "Nightly evaluation indicates a quality regression. Review recent deployments and reranker changes."
      - alert: RetrievalCacheHitDrop
        expr: avg_over_time(reranking_cache_hit_rate[15m]) < 0.4
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Reranking cache hit rate below 40%"
          description: "Warm cache or adjust candidate counts to avoid GPU overload."
      - alert: RetrievalGpuSaturation
        expr: max_over_time(reranking_gpu_utilization_percent[10m]) > 90
  - name: mineru-vllm
    rules:
      - alert: MinerUVLLMClientFailures
        expr: sum(rate(mineru_vllm_client_failures_total[5m])) by (error_type) > 2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "MinerU vLLM client failures above threshold"
          description: |
            Error type {{ $labels.error_type }} is breaching the expected threshold. Investigate vLLM availability
            and recent deployment events.
      - alert: MinerUVLLMCircuitBreakerOpen
        expr: mineru_vllm_circuit_breaker_state == 2
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "MinerU vLLM circuit breaker is OPEN"
          description: |
            Circuit breaker is open which means workers are refusing to call vLLM. Check GPU utilisation and
            service health immediately.
      - alert: MinerUVLLMHighLatency
        expr: histogram_quantile(0.95, sum(rate(mineru_vllm_request_duration_seconds_bucket[5m])) by (le)) > 10
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Reranking GPU utilisation over 90%"
          description: "Consider scaling gateway replicas or reducing rerank_candidates to restore headroom."
          summary: "MinerU vLLM P95 latency over 10 seconds"
          description: |
            vLLM request latency is degrading. Review batching configuration and GPU pressure before pipelines stall.
